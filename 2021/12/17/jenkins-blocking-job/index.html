<!DOCTYPE html>
<html lang="en">

<head>
    <title>andy reagan</title>
    <meta charset="utf-8" />
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">



<meta name="tags" contents="jenkins" />
<meta name="tags" contents="python" />
<meta name="tags" contents="shell" />

    <link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/beemuse.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/base.css">
    <!-- <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css"> -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script> -->
</head>

<body>

    <section id="navbar">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/index.html">andyreagan.com</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li ><a href="/pages/blog.html">Blog</a></li>
                        <li ><a href="/pages/about-me.html">About</a></li>
                        <li ><a href="/pages/publications.html">Publications</a></li>
                        <li ><a href="/pages/teaching.html">Teaching</a></li>
                        <li ><a href="/pages/visualizations.html">Visualizations</a></li>
                    </ul>
                </div>
                <!--/.nav-collapse -->
            </div>
        </div>
    </section>

<br>
<section class="content">
    <div class="row">

        <div class="col-xs-12 col-md-8  col-md-offset-2 col-lg-6 col-lg-offset-3">
            <div class="paper">
                <header>
                    <h2 class="entry-title">
                        <a href="https://andyreagan.github.io/2021/12/17/jenkins-blocking-job/" rel="bookmark" title="Permalink to Jenkins blocking job">Jenkins blocking job</a></h2>
                    
                </header>
                <footer class="post-info">
                    <abbr class="published" title="2021-12-17T00:00:00+01:00">
                        Fri 17 December 2021
                    </abbr>
                    &nbsp;
                    &nbsp;
                    <a href="https://github.com/andyreagan/andyreagan.github.io/edit/main/content/2021-12-27-jenkins-blocker.md">Edit on Github</a>
                </footer><!-- /.post-info -->
                <br>
                <div class="entry-content">
                    <p>Say you have a job, that depends on three other jobs having been completed.
They all run at the same time,
and are not explicitly a part of your pipeline (you can't put them as a single multijob step).
You need you job to depend on at least one of them as upstream,
but then to make sure the others aren't still running.
So you create another job, which is triggered by 1 of those upstream jobs explicitly,
then watches the others.
Your job is then downstream of this "blocker" job, that will wait for completion
of <em>all</em> of the upstreams.
This is weird "hack" to get a Jenkins job to wait for a set of jobs (or a single one) to be not in a running state.</p>
<div class="highlight"><pre><span></span><code><span class="nb">test</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$JOBS_TO_WAIT_FOR</span>
<span class="nb">test</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$JENKINS_URI</span>

<span class="c1"># setup python environment</span>
pip<span class="w"> </span>install<span class="w"> </span>requests

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;import json</span>
<span class="s2">import requests</span>
<span class="s2">import time</span>
<span class="s2">jobs = &#39;</span><span class="si">${</span><span class="nv">JOB_TO_WAIT_FOR</span><span class="si">}</span><span class="s2">&#39;.strip().split(&#39;,&#39;)</span>
<span class="s2">anime = [True for job in jobs]</span>

<span class="s2"># wait for completion</span>
<span class="s2">while sum(anime) &gt; 0:</span>
<span class="s2">    for i, job in enumerate(jobs):</span>
<span class="s2">        if anime[i]:</span>
<span class="s2">            r = requests.get(&#39;{JENKINS_URI}/job/{job}/api/json?pretty=true&#39;.format(job=job))</span>
<span class="s2">            print(r.content)</span>
<span class="s2">            x = json.loads(r.content.decode(&#39;utf-8&#39;))</span>
<span class="s2">            print(x)</span>
<span class="s2">            anime[i] = (&#39;anime&#39; in x[&#39;color&#39;])</span>
<span class="s2">    time.sleep(5)</span>

<span class="s2"># now check that they all had a successful last run (optional, of course)</span>
<span class="s2">time.sleep(5)</span>
<span class="s2">for job in jobs:</span>
<span class="s2">    r = requests.get(&#39;{JENKINS_URI}/job/{job}/api/json?pretty=true&#39;.format(job=job))</span>
<span class="s2">    print(r.content)</span>
<span class="s2">    x = json.loads(r.content.decode(&#39;utf-8&#39;))</span>
<span class="s2">    print(&#39;-&#39;*80)</span>
<span class="s2">    print(x)</span>
<span class="s2">    # make sure it was a success</span>
<span class="s2">    assert x[&#39;lastCompletedBuild&#39;][&#39;number&#39;] == x[&#39;lastSuccessfulBuild&#39;][&#39;number&#39;]</span>
<span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>python<span class="w"> </span>-
</code></pre></div>

<p>I noted down this idea a couple years ago, with source code here: https://gist.github.com/andyreagan/ce25939367bcb2e6be9ce4f41a5edd8f.</p>
<p>Merry hacking!</p>
                </div> <!-- /.entry-content -->
            </div> <!-- /.paper -->
        </div> <!-- /.col -->
    </div> <!-- /.row -->
</section><!-- /#content -->

    <footer id="slidingfooter" class="body">
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Site design by Andy Reagan.
    </footer><!-- /#contentinfo -->
</body>
</script>

</html>