<!DOCTYPE html>
<html lang="en">

<head>
    <title>andy reagan</title>
    <meta charset="utf-8" />
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">



<meta name="tags" contents="python" />
<meta name="tags" contents="dbt" />

    <link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/beemuse.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/base.css">
    <!-- <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css"> -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script> -->
</head>

<body>

    <section id="navbar">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/index.html">andyreagan.com</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li ><a href="/pages/blog.html">Blog</a></li>
                        <li ><a href="/pages/about-me.html">About</a></li>
                        <li ><a href="/pages/publications.html">Publications</a></li>
                        <li ><a href="/pages/teaching.html">Teaching</a></li>
                        <li ><a href="/pages/visualizations.html">Visualizations</a></li>
                    </ul>
                </div>
                <!--/.nav-collapse -->
            </div>
        </div>
    </section>

<br>
<section class="content">
    <div class="row">

        <div class="col-xs-12 col-md-8  col-md-offset-2 col-lg-6 col-lg-offset-3">
            <div class="paper">
                <header>
                    <h2 class="entry-title">
                        <a href="https://andyreagan.github.io/2022/03/31/non-sql-in-your-dbt-pipeline/" rel="bookmark" title="Permalink to Non-SQL in your DBT pipeline">Non-SQL in your DBT pipeline</a></h2>
                    
                </header>
                <footer class="post-info">
                    <abbr class="published" title="2022-03-31T00:00:00+02:00">
                        Thu 31 March 2022
                    </abbr>
                    &nbsp;
                    &nbsp;
                    <a href="https://github.com/andyreagan/andyreagan.github.io/edit/main/content/2022-03-31-non-sql-in-dbt-pipeline.md">Edit on Github</a>
                </footer><!-- /.post-info -->
                <br>
                <div class="entry-content">
                    <p>DBT forces you to use SQL, even when Python or R transformations are clearer.</p>
<p>DBT makes a lot of sense for 80% of data pipelines, but there are steps that it just isn’t worth forcing into SQL (even when that is possible!). If the code is simpler and easier to understand in a more extensible programming language (e.g., R or Python), then the code should stay there. While DBT forces good practices for keeping pipelines in SQL most of the time, this can be an anti-pattern when we add complexity just to stay in SQL-land.</p>
<p>Many Google searches later, and I found Claire Carroll lays out the scenario very clearly in her post on the DBT forum <a href="https://discourse.getdbt.com/t/representing-non-sql-models-in-a-dbt-dag/2083">Representing non-SQL models in a dbt DAG</a>:</p>
<blockquote>
<p>Sometimes, there’s a table in your DAG that might be created via a non-SQL process, and it would be useful for your dbt project to “know” about it. For example, let’s say you have a table, <code>customers_predicted_ltvs</code>, with one record per <code>customer_id</code>:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">customer_id</th>
<th>predicted_ltv</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1</td>
<td>120</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td>115</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td>...</td>
</tr>
</tbody>
</table>
<p>This table of estimates is created by a machine learning model, and uses transformations which can’t be done in SQL — we’re going to call it a non-SQL model. The non-SQL model uses some dbt models as inputs. Further, you want to use the output of this non-SQL model in other dbt models.</p>
</blockquote>
<p>She is not the first person to ask the <a href="https://stackoverflow.com/questions/63419289/how-to-use-python-dependency-injection-or-hooks-with-dbt">this question</a>, and she proposes a useful answer, to “hack” the model into the pipeline with an ephemeral model:</p>
<div class="highlight"><pre><span></span><code><span class="err">{{</span><span class="w"> </span><span class="n">config</span><span class="p">(</span><span class="n">materialized</span><span class="o">=</span><span class="s1">&#39;ephemeral&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">}}</span>
<span class="cm">/*</span>
<span class="cm">This table is created by a non-SQL process (you should probably add more info IRL),</span>
<span class="cm">which selects from the following dbt models:</span>
<span class="cm">{{ ref(&#39;customers&#39;) }}</span>
<span class="cm">{{ ref(&#39;orders&#39;) }}</span>
<span class="cm">*/</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">my_schema</span><span class="p">.</span><span class="n">customers_predicted_ltv</span>
</code></pre></div>

<p>I’ll add that you can make this more generic by dynamically populating the table and schema names:</p>
<div class="highlight"><pre><span></span><code><span class="err">{{</span><span class="w"> </span><span class="n">config</span><span class="p">(</span><span class="n">materialized</span><span class="o">=</span><span class="s1">&#39;ephemeral&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">}}</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">{{</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="k">schema</span><span class="w"> </span><span class="err">}}</span><span class="p">.</span><span class="err">{{</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="err">}}</span>
</code></pre></div>

<p>And this is what we’re left with. You don’t <em>need</em> this hacked-in node if you just run the pipeline up to this point, and then after it (splitting it in two), but this placeholder does allow you build the full DAG picture. Even with this in place, you’ll still need to run your pipeline in two steps anyway. First, everything up to this model, then you external process, then everything after it:</p>
<div class="highlight"><pre><span></span><code>dbt<span class="w"> </span>run<span class="w"> </span>+customers_predicted_ltv
python<span class="w"> </span>my_process.py
Rscript<span class="w"> </span>my_process.R
dbt<span class="w"> </span>run<span class="w"> </span>customers_predicted_ltv+
</code></pre></div>

<p>One tool sounds promising, called <a href="https://github.com/fal-ai/fal">fal</a>, ̶b̶u̶t̶ ̶f̶o̶r̶ ̶n̶o̶w̶ ̶t̶h̶i̶s̶ ̶o̶n̶l̶y̶ ̶a̶l̶l̶o̶w̶s̶ ̶y̶o̶u̶ ̶t̶o̶ ̶r̶u̶n̶ ̶s̶c̶r̶i̶p̶t̶s̶ ̶b̶e̶f̶o̶r̶e̶ ̶o̶r̶ ̶a̶f̶t̶e̶r̶ ̶y̶o̶u̶r̶ ̶D̶A̶G̶,̶ ̶n̶o̶t̶ ̶i̶n̶ ̶t̶h̶e̶ ̶m̶i̶d̶d̶l̶e̶ as I published this, the fal team released just such a feature: <a href="https://blog.fal.ai/python-or-sql-why-not-both/">check it out</a>. I also found a tool called <a href="https://medium.com/@jordan_volz/add-machine-learning-to-your-dbt-workflows-with-continual-27f609c7c76d">Continual</a>, which looks similar to <code>fal</code>, with somewhat less documentation.</p>
<style>
table {
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9em;
    font-family: sans-serif;
    min-width: 400px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
}

thead tr {
    background-color: #009879;
    color: #ffffff;
    text-align: left;
}

th,
td {
    padding: 12px 15px;
}

tbody tr.active-row {
    font-weight: bold;
    color: #009879;
}
tbody tr {
    border-bottom: 1px solid #dddddd;
}

tbody tr:nth-of-type(even) {
    background-color: #f3f3f3;
}

tbody tr:last-of-type {
    border-bottom: 2px solid #009879;
}
</style>
                </div> <!-- /.entry-content -->
            </div> <!-- /.paper -->
        </div> <!-- /.col -->
    </div> <!-- /.row -->
</section><!-- /#content -->

    <footer id="slidingfooter" class="body">
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Site design by Andy Reagan.
    </footer><!-- /#contentinfo -->
</body>
</script>

</html>